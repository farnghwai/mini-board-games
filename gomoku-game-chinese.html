<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>‰∫îÂ≠êÊ£ã - ËàáÂ∞èÂÖãÂ∞çÂºà</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #f5f5dc 0%, #e8ddc0 100%);
            --card-bg: white;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
            --primary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --board-bg: #b45309;
            --board-inner: #d97706;
            --board-lines: #8b4513;
            --text-primary: #4a4a4a;
            --text-secondary: #666;
            --border-radius: 0.9375rem;
            --touch-target: max(2.75rem, 44px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: clamp(14px, 4vw, 18px);
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft YaHei", "ÂæÆËªüÊ≠£ÈªëÈ´î", sans-serif;
            background: var(--primary-bg);
            position: fixed;
            inset: 0;
            overflow: hidden;
            overscroll-behavior: none;
            user-select: none;
            padding: 0;
        }

        #gameContainer {
            display: grid;
            grid-template-rows: 1fr;
            height: 100%;
            width: 100%;
            max-width: min(400px, 90vw);
            margin: 0 auto;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            padding: clamp(0.5rem, 2vw, 1rem);
            box-sizing: border-box;
        }

        #welcomeScreen {
            grid-column: 1;
            grid-row: 1 / -1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: clamp(1.25rem, 5vw, 2rem);
            gap: 1rem;
        }

        .welcomeTitle {
            font-size: clamp(1.5rem, 5vw, 2rem);
            color: var(--text-primary);
            font-weight: bold;
            line-height: 1.2;
        }

        .welcomeMessage {
            font-size: clamp(1rem, 4vw, 1.25rem);
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 20ch;
        }

        .startButton {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 1.5625rem;
            padding: 0.75rem 2.5rem;
            font-size: clamp(1rem, 4vw, 1.375rem);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: transform 0.2s;
            min-height: var(--touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .startButton:active {
            transform: scale(0.95);
        }

        .startButton:focus-visible {
            outline: 2px solid var(--text-primary);
            outline-offset: 2px;
        }

        #gameScreen {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            gap: clamp(0.5rem, 2vw, 1rem);
        }

        #gameScreen.active {
            display: flex;
        }

        .game-header {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex-shrink: 0;
        }


        .gameTitle {
            font-size: clamp(1.25rem, 5vw, 1.75rem);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        #scoreArea {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: clamp(1.5rem, 5vw, 2rem);
            margin-bottom: 0.75rem;
        }

        .scoreItem {
            font-size: clamp(0.875rem, 3.5vw, 1.125rem);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stone {
            width: clamp(1.25rem, 4vw, 1.5rem);
            height: clamp(1.25rem, 4vw, 1.5rem);
            border-radius: 50%;
            display: inline-block;
        }

        .blackStone {
            background: #000;
        }

        .whiteStone {
            background: #fff;
            border: 1px solid #333;
        }

        #messageArea {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: clamp(0.75rem, 3vw, 1rem);
            box-shadow: var(--card-shadow);
            min-height: clamp(2.5rem, 6vw, 3.5rem);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #aiMessage {
            font-size: clamp(0.875rem, 3.5vw, 1.125rem);
            color: var(--text-primary);
            text-align: center;
            line-height: 1.5;
        }

        .game-board-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-height: 0;
        }

        #boardContainer {
            background: var(--board-bg);
            border-radius: 0.625rem;
            padding: clamp(0.5rem, 2vw, 0.75rem);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
            width: min(80vw, 80vh, 400px);
            aspect-ratio: 1;
            container-type: inline-size;
        }

        #gameBoard {
            background: var(--board-inner);
            padding: 0.125rem;
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 0.3125rem;
            touch-action: none;
        }

        .boardRow {
            display: flex;
            width: 100%;
            height: calc(100% / 13);
        }

        .boardCell {
            width: calc(100% / 13);
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-width: max(18px, 5cqw);
            min-height: max(18px, 5cqw);
        }

        @container (max-width: 280px) {
            .boardCell {
                min-width: 16px;
                min-height: 16px;
            }
        }

        .gridLines {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .gridLine {
            stroke: var(--board-lines);
            stroke-width: 1;
        }

        .placedStone {
            width: max(80%, 16px);
            height: max(80%, 16px);
            border-radius: 50%;
            z-index: 10;
            position: relative;
            transition: transform 0.2s;
        }

        @container (min-width: 350px) {
            .placedStone {
                width: max(85%, 20px);
                height: max(85%, 20px);
            }
        }

        .placedStone.black {
            background: radial-gradient(circle at 30% 30%, #4a4a4a, #000000);
            box-shadow: 0.125rem 0.125rem 0.25rem rgba(0,0,0,0.5);
        }

        .placedStone.white {
            background: radial-gradient(circle at 30% 30%, #ffffff, #e0e0e0);
            border: 1px solid #ccc;
            box-shadow: 0.125rem 0.125rem 0.25rem rgba(0,0,0,0.3);
        }

        .placedStone.lastMove {
            box-shadow: 0 0 0 2px #ef4444, 0.125rem 0.125rem 0.25rem rgba(0,0,0,0.5);
        }

        .placedStone.winning {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 2px #10b981; }
            50% { box-shadow: 0 0 0 4px #10b981; }
        }

        .hoverPreview {
            width: max(75%, 14px);
            height: max(75%, 14px);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 5;
            position: relative;
        }

        @container (min-width: 350px) {
            .hoverPreview {
                width: max(80%, 18px);
                height: max(80%, 18px);
            }
        }

        .starPoint {
            position: absolute;
            width: max(0.375rem, 1.5cqw);
            height: max(0.375rem, 1.5cqw);
            background: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        @container (max-width: 250px) {
            .starPoint {
                width: 0.25rem;
                height: 0.25rem;
            }
        }

        .game-footer {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }

        #gameActions {
            min-height: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.25rem 0;
            gap: 0.5rem;
        }

        #gameActions .gameButton {
            display: none;
        }

        #gameActions .gameButton.show {
            display: flex;
        }


        .gameButton {
            padding: clamp(0.75rem, 3vw, 1rem) clamp(1.25rem, 4vw, 2rem);
            font-size: clamp(0.875rem, 3.5vw, 1.125rem);
            font-weight: bold;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            min-height: var(--touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gameButton:active {
            transform: scale(0.95);
        }

        .gameButton:focus-visible {
            outline: 2px solid var(--text-primary);
            outline-offset: 2px;
        }

        .gameButton.start {
            background: var(--primary-gradient);
        }

        .gameButton.restart {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .gameButton.newSession {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .gameButton.inline {
            padding: 0.5rem 1.5rem;
            font-size: 0.875rem;
            min-height: 2rem;
            border-radius: 1rem;
        }

        #sessionInfo {
            text-align: center;
            color: var(--text-secondary);
            font-size: clamp(0.75rem, 3vw, 0.875rem);
        }

        .hidden {
            display: none !important;
        }

        /* Small screens - better layout */
        @media (max-width: 400px) {

            #scoreArea {
                gap: 1rem;
            }

            .scoreItem {
                font-size: 0.875rem;
            }
        }

        /* Very small screens */
        @media (max-width: 320px) {
            :root {
                --touch-target: max(2.5rem, 40px);
            }

            #gameContainer {
                padding: 0.5rem;
                gap: 0.5rem;
            }
        }

        /* Large screens */
        @media (min-width: 768px) {
            body {
                position: static;
                overflow: auto;
                background-attachment: fixed;
            }

            #gameContainer {
                height: auto;
                min-height: 100vh;
                max-width: 500px;
                padding: 2rem;
            }

            .game-board-area {
                justify-content: center;
                align-items: center;
            }

            #boardContainer {
                width: min(400px, 60vh);
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-contrast: high) {
            :root {
                --card-shadow: 0 4px 15px rgba(0,0,0,0.3);
                --text-primary: #000000;
                --text-secondary: #333333;
            }

            .placedStone.black {
                border: 2px solid #000000;
            }

            .placedStone.white {
                border: 2px solid #333333;
            }
        }

        /* Compact mode for small height screens */
        @media (max-height: 650px) {
            #gameContainer {
                gap: 0.25rem;
            }

            .game-header, .game-footer {
                gap: 0.25rem;
            }

            #messageArea {
                min-height: 2.5rem;
                padding: 0.5rem;
            }

            #gameActions {
                min-height: 2.5rem;
                padding: 0.125rem 0;
            }


            #scoreArea {
                gap: 1rem;
                margin-bottom: 0.25rem;
            }

            .scoreItem {
                font-size: 0.75rem;
            }

            .gameButton {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                min-height: 2.5rem;
            }

            #sessionInfo {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <div class="welcomeTitle">‰∫îÂ≠êÊ£ã</div>
            <div class="welcomeMessage">
                ÊÇ®Â•ΩÔºÅÊàëÊòØÊ£ãÂèãÂ∞èÂÖã<br>
                Ê∫ñÂÇôÂ•Ω‰æÜ‰∏ÄÂ±Ä‰∫îÂ≠êÊ£ãÂóéÔºü
            </div>
            <button class="startButton" onclick="startFirstGame()">ÈñãÂßã‰∏ãÊ£ã üòä</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen">
            <div class="game-header">
                <h1 class="gameTitle">‰∫îÂ≠êÊ£ã</h1>
                <div id="scoreArea">
                    <div class="scoreItem">
                        <span>ÊÇ®Ôºö</span>
                        <span id="playerScore">0</span>
                        <span class="stone blackStone"></span>
                    </div>
                    <div class="scoreItem">
                        <span>Â∞èÂÖãÔºö</span>
                        <span id="npcScore">0</span>
                        <span class="stone whiteStone"></span>
                    </div>
                </div>

                <div id="messageArea">
                    <div id="aiMessage">Ê∫ñÂÇôÈñãÂßã...</div>
                </div>
            </div>

            <div class="game-board-area">
                <div id="boardContainer">
                    <div id="gameBoard"></div>
                </div>
            </div>

            <div class="game-footer">
                <div id="gameActions">
                    <button class="gameButton inline restart hidden" onclick="startNewGame()">ÂÜç‰æÜ‰∏ÄÂ±Ä</button>
                    <button class="gameButton inline newSession hidden" onclick="newSession()">Êñ∞Â±Ä</button>
                </div>

                <div id="sessionInfo">
                    Á¨¨ <span id="sessionGames">0</span> Â±Ä ‚Ä¢ ‰ªäÊó•Â∑≤Áé© <span id="totalGames">0</span> Â±Ä
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Game state
        let board = [];
        let currentPlayer = 'player';
        let gameActive = false;
        let isProcessing = false;
        let score = { player: 0, npc: 0 };
        let sessionGames = 0;
        let totalGamesToday = 0;
        let lastMove = null;
        let winningLine = null;
        let hoveredPosition = null;

        // NPC settings
        let npcDifficulty = 'easy';
        let localResponsesUsed = [];

        // Local response system - Chinese language
        const localResponses = {
            greetings: [
                "‰æÜ‰∏ãÊ£ãÂêßÔºÅÊÇ®Âü∑ÈªëÂ≠êÂÖà‰∏ãÔºÅ‚ö´",
                "ÈñãÂßãÂõâÔºÅÈªûÊìäÊ£ãÁõ§‰ªªÊÑè‰ΩçÁΩÆËêΩÂ≠êÔºÅ",
                "ÊàëÂÄë‰æÜ‰∏ã‰∫îÂ≠êÊ£ãÔºÅÊÇ®ÂÖàË´ãÔºÅ",
                "Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºüËºïËß∏Ê£ãÁõ§ÈñãÂßãÔºÅ"
            ],
            playerMoves: {
                good: ["Â•ΩÊ£ãÔºÅ", "‰∏çÈåØÂñîÔºÅ", "ÊúâÊÑèÊÄùÔºÅ", "Âé≤ÂÆ≥ÔºÅ", "ÊÇ®ÁúüËÅ∞ÊòéÔºÅ"],
                normal: ["Ëº™Âà∞Êàë‰∫Ü", "Êàë‰æÜÊÉ≥ÊÉ≥", "ÂóØ...", "ËÆìÊàëÁúãÁúã", "Êúâ‰∫ÜÔºÅ"],
                winning: ["ÂìéÂëÄÔºåÊÇ®Ë¶ÅË¥è‰∫ÜÔºÅ", "ÊàëÂæóÂ∞èÂøÉ‰∫ÜÔºÅ", "Âç±Èö™ÂïäÔºÅ", "ÊÇ®ÁöÑÊ£ãË∑ØÂæàÂé≤ÂÆ≥ÔºÅ"]
            },
            npcMoves: {
                normal: ["Êàë‰∏ãÈÄôË£°ÔºÅ", "Ë©¶Ë©¶ÈÄôÊ≠•", "ÈÄôË£°Â¶Ç‰ΩïÔºü", "ÊàëËµ∞‰∏ÄÊ≠•", "Ëº™Âà∞ÊàëÂõâÔºÅ"],
                blocking: ["Êìã‰ΩèÔºÅüòä", "‰∏çËÉΩËÆìÊÇ®ÂæóÊâãÔºÅ", "ÊàëÁúãÂà∞‰∫ÜÔºÅ", "ÊîîÊà™ÔºÅ", "ÂìàÂìàÔºåÊìã‰Ωè‰∫ÜÔºÅ"],
                winning: ["ÈÄôÊ≠•‰∏çÈåØ", "ÊàëÂñúÊ≠°ÈÄôÂÄã‰ΩçÁΩÆ", "ÂóØÔºåÈÄôË£°ÔºÅ", "ËÆìÊàëË©¶Ë©¶..."]
            },
            playerWin: [
                "ÊÅ≠ÂñúÊÇ®Ë¥è‰∫ÜÔºÅüéâ",
                "ÊÇ®ÁúüÂé≤ÂÆ≥ÔºÅ‰Ω©Êúç‰Ω©ÊúçÔºÅ",
                "ÊÇ®Ë¥èÂï¶ÔºÅÂÜç‰æÜ‰∏ÄÂ±ÄÂóéÔºü",
                "È´òÊâãÔºÅÊÇ®Ë¥è‰∫ÜÔºÅ",
                "ÊºÇ‰∫ÆÔºÅÈÄôÂ±ÄÊÇ®Ë¥è‰∫ÜÔºÅ"
            ],
            npcWin: [
                "ÊàëÂÉ•ÂÄñË¥è‰∫ÜÔºÅÂÜç‰æÜ‰∏ÄÂ±ÄÂóéÔºü",
                "ÈÄôÂ±ÄÊàëË¥è‰∫ÜÔºåÂÜçË©¶Ë©¶ÁúãÔºü",
                "ÊâøËÆì‰∫ÜÔºÅË¶Å‰∏çË¶ÅÂÜç‰æÜÔºü",
                "ÈÅãÊ∞£‰∏çÈåØÔºåÊàëË¥è‰∫ÜÔºÅ"
            ],
            draw: [
                "Âπ≥Â±ÄÔºÅÊàëÂÄëÂØ¶ÂäõÁõ∏Áï∂ÔºÅ",
                "ÂíåÊ£ã‰∫ÜÔºÅÁ≤æÂΩ©ÁöÑÂ∞çÂ±ÄÔºÅ",
                "‰∏çÂàÜÂãùË≤†ÔºÅÂÜç‰æÜ‰∏ÄÂ±ÄÔºü"
            ],
            encouragement: [
                "ÊÇ®‰∏ãÂæóÂæàÂ•ΩÔºÅ",
                "ÊÖ¢ÊÖ¢‰æÜÔºå‰∏çËëóÊÄ•ÔºÅ",
                "Â•ΩÊ£ãÂ±ÄÔºÅ",
                "ÁúüÊúâË∂£ÔºÅ",
                "ÊÇ®Ë∂ä‰æÜË∂äÂé≤ÂÆ≥‰∫ÜÔºÅ"
            ]
        };

        // Initialize board
        function initBoard() {
            board = Array(13).fill(null).map(() => Array(13).fill(null));
            lastMove = null;
            winningLine = null;
            currentPlayer = 'player';
            renderBoard();
        }

        // Render board
        function renderBoard() {
            const boardElement = document.getElementById('gameBoard');
            boardElement.innerHTML = '';

            for (let row = 0; row < 13; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'boardRow';

                for (let col = 0; col < 13; col++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'boardCell';
                    cellDiv.dataset.row = row;
                    cellDiv.dataset.col = col;

                    // Add grid lines
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.classList.add('gridLines');
                    svg.setAttribute('width', '100%');
                    svg.setAttribute('height', '100%');

                    // Horizontal line
                    if (col < 12) {
                        const hLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        hLine.setAttribute('x1', '50%');
                        hLine.setAttribute('y1', '50%');
                        hLine.setAttribute('x2', '100%');
                        hLine.setAttribute('y2', '50%');
                        hLine.classList.add('gridLine');
                        svg.appendChild(hLine);
                    }
                    if (col > 0) {
                        const hLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        hLine.setAttribute('x1', '0');
                        hLine.setAttribute('y1', '50%');
                        hLine.setAttribute('x2', '50%');
                        hLine.setAttribute('y2', '50%');
                        hLine.classList.add('gridLine');
                        svg.appendChild(hLine);
                    }

                    // Vertical line
                    if (row < 12) {
                        const vLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        vLine.setAttribute('x1', '50%');
                        vLine.setAttribute('y1', '50%');
                        vLine.setAttribute('x2', '50%');
                        vLine.setAttribute('y2', '100%');
                        vLine.classList.add('gridLine');
                        svg.appendChild(vLine);
                    }
                    if (row > 0) {
                        const vLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        vLine.setAttribute('x1', '50%');
                        vLine.setAttribute('y1', '0');
                        vLine.setAttribute('x2', '50%');
                        vLine.setAttribute('y2', '50%');
                        vLine.classList.add('gridLine');
                        svg.appendChild(vLine);
                    }

                    cellDiv.appendChild(svg);

                    // Add star points
                    if ((row === 3 && col === 3) ||
                        (row === 3 && col === 9) ||
                        (row === 9 && col === 3) ||
                        (row === 9 && col === 9) ||
                        (row === 6 && col === 6)) {
                        const starPoint = document.createElement('div');
                        starPoint.className = 'starPoint';
                        cellDiv.appendChild(starPoint);
                    }

                    // Add stone if present
                    if (board[row][col]) {
                        const stone = document.createElement('div');
                        stone.className = 'placedStone';
                        stone.classList.add(board[row][col] === 'player' ? 'black' : 'white');

                        // Highlight last move
                        if (lastMove && lastMove.row === row && lastMove.col === col) {
                            stone.classList.add('lastMove');
                        }

                        // Highlight winning stones
                        if (winningLine && winningLine.some(([r, c]) => r === row && c === col)) {
                            stone.classList.add('winning');
                        }

                        cellDiv.appendChild(stone);
                    }

                    // Add click handler
                    cellDiv.onclick = () => handleCellClick(row, col);
                    cellDiv.onmouseenter = () => handleCellHover(row, col, true);
                    cellDiv.onmouseleave = () => handleCellHover(row, col, false);

                    rowDiv.appendChild(cellDiv);
                }

                boardElement.appendChild(rowDiv);
            }
        }

        // Handle cell click
        function handleCellClick(row, col) {
            if (!gameActive || currentPlayer !== 'player' || isProcessing) return;
            if (board[row][col] !== null) return;

            isProcessing = true;

            // Place player stone
            board[row][col] = 'player';
            lastMove = { row, col };
            renderBoard();

            // Check for player win
            const playerWin = checkWinner(row, col, 'player');
            if (playerWin) {
                winningLine = playerWin;
                renderBoard();
                score.player++;
                totalGamesToday++;
                localStorage.setItem('gomokuGamesToday', totalGamesToday.toString());
                updateScore();
                updateSessionInfo();
                showMessage(getLocalResponse('playerWin'));
                gameActive = false;
                isProcessing = false;
                showEndButtons();
                return;
            }

            // Check for draw
            if (checkDraw()) {
                showMessage(getLocalResponse('draw'));
                gameActive = false;
                isProcessing = false;
                showEndButtons();
                return;
            }

            // Show processing message
            showMessage(getLocalResponse('playerMoves', 'normal'));

            // NPC turn
            currentPlayer = 'npc';
            setTimeout(() => {
                makeNPCMove();
            }, 800);
        }

        // Handle cell hover
        function handleCellHover(row, col, isHovering) {
            if (!gameActive || currentPlayer !== 'player' || board[row][col] !== null) {
                return;
            }

            const cell = document.querySelector(`.boardCell[data-row="${row}"][data-col="${col}"]`);
            const existingPreview = cell.querySelector('.hoverPreview');

            if (isHovering && !existingPreview) {
                const preview = document.createElement('div');
                preview.className = 'hoverPreview';
                cell.appendChild(preview);
            } else if (!isHovering && existingPreview) {
                existingPreview.remove();
            }
        }

        // Make NPC move
        function makeNPCMove() {
            const move = calculateNPCMove();
            if (!move) {
                showMessage("Ê≤íÂú∞Êñπ‰∏ã‰∫ÜÔºÅ");
                gameActive = false;
                isProcessing = false;
                showEndButtons();
                return;
            }

            board[move.row][move.col] = 'npc';
            lastMove = { row: move.row, col: move.col };
            renderBoard();

            // Check for NPC win
            const npcWin = checkWinner(move.row, move.col, 'npc');
            if (npcWin) {
                winningLine = npcWin;
                renderBoard();
                score.npc++;
                totalGamesToday++;
                localStorage.setItem('gomokuGamesToday', totalGamesToday.toString());
                updateScore();
                updateSessionInfo();
                showMessage(getLocalResponse('npcWin'));
                gameActive = false;
                isProcessing = false;
                showEndButtons();
                return;
            }

            // Check for draw
            if (checkDraw()) {
                showMessage(getLocalResponse('draw'));
                gameActive = false;
                isProcessing = false;
                showEndButtons();
                return;
            }

            // Continue game
            showMessage(getLocalResponse('npcMoves', 'normal'));
            currentPlayer = 'player';
            isProcessing = false;
        }

        // Calculate NPC move
        function calculateNPCMove() {
            // Check for winning move (4 in a row, need 5th)
            const winMove = findBestMove('npc', 5);
            if (winMove) return winMove;

            // Check for blocking move (opponent has 4)
            const blockMove = findBestMove('player', 5);
            if (blockMove) return blockMove;

            // Check for creating 4 in a row
            const createFour = findBestMove('npc', 4);
            if (createFour) return createFour;

            // Block opponent's 3 in a row
            const blockThree = findBestMove('player', 4);
            if (blockThree) return blockThree;

            // Easy mode: sometimes make random moves
            if (npcDifficulty === 'easy' && Math.random() < 0.3) {
                return getRandomMove();
            }

            // Prefer center area
            return getCenterMove();
        }

        // Find best move for target length
        function findBestMove(player, targetLength) {
            for (let row = 0; row < 13; row++) {
                for (let col = 0; col < 13; col++) {
                    if (board[row][col] === null) {
                        // Test this position
                        board[row][col] = player;
                        const length = checkLineLength(row, col, player);
                        board[row][col] = null;

                        if (length >= targetLength) {
                            return { row, col };
                        }
                    }
                }
            }
            return null;
        }

        // Check line length from position
        function checkLineLength(row, col, player) {
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]  // horizontal, vertical, diagonal
            ];

            let maxLength = 1;

            for (let [dr, dc] of directions) {
                let length = 1;

                // Check forward direction
                for (let i = 1; i < 5; i++) {
                    const r = row + dr * i;
                    const c = col + dc * i;
                    if (r >= 0 && r < 13 && c >= 0 && c < 13 && board[r][c] === player) {
                        length++;
                    } else break;
                }

                // Check backward direction
                for (let i = 1; i < 5; i++) {
                    const r = row - dr * i;
                    const c = col - dc * i;
                    if (r >= 0 && r < 13 && c >= 0 && c < 13 && board[r][c] === player) {
                        length++;
                    } else break;
                }

                maxLength = Math.max(maxLength, length);
            }

            return maxLength;
        }

        // Get random move near existing stones
        function getRandomMove() {
            const availableMoves = [];
            for (let row = 0; row < 13; row++) {
                for (let col = 0; col < 13; col++) {
                    if (board[row][col] === null) {
                        // Prefer moves near existing stones
                        if (hasNeighbor(row, col)) {
                            availableMoves.push({ row, col });
                        }
                    }
                }
            }

            if (availableMoves.length === 0) {
                // If no moves near stones, pick center area
                return getCenterMove();
            }

            return availableMoves[Math.floor(Math.random() * availableMoves.length)];
        }

        // Check if position has neighbor
        function hasNeighbor(row, col) {
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const r = row + dr;
                    const c = col + dc;
                    if (r >= 0 && r < 13 && c >= 0 && c < 13 && board[r][c] !== null) {
                        return true;
                    }
                }
            }
            return false;
        }

        // Get center area move
        function getCenterMove() {
            const center = 6;
            const range = 3;

            for (let d = 0; d <= range; d++) {
                for (let row = center - d; row <= center + d; row++) {
                    for (let col = center - d; col <= center + d; col++) {
                        if (row >= 0 && row < 13 && col >= 0 && col < 13 && board[row][col] === null) {
                            return { row, col };
                        }
                    }
                }
            }

            // Fallback to any empty position
            for (let row = 0; row < 13; row++) {
                for (let col = 0; col < 13; col++) {
                    if (board[row][col] === null) {
                        return { row, col };
                    }
                }
            }

            return null;
        }

        // Check for winner
        function checkWinner(lastRow, lastCol, player) {
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]  // horizontal, vertical, diagonal
            ];

            for (let [dr, dc] of directions) {
                let count = 1;
                const line = [[lastRow, lastCol]];

                // Check forward direction
                for (let i = 1; i < 5; i++) {
                    const r = lastRow + dr * i;
                    const c = lastCol + dc * i;
                    if (r >= 0 && r < 13 && c >= 0 && c < 13 && board[r][c] === player) {
                        count++;
                        line.push([r, c]);
                    } else break;
                }

                // Check backward direction
                for (let i = 1; i < 5; i++) {
                    const r = lastRow - dr * i;
                    const c = lastCol - dc * i;
                    if (r >= 0 && r < 13 && c >= 0 && c < 13 && board[r][c] === player) {
                        count++;
                        line.unshift([r, c]);
                    } else break;
                }

                if (count >= 5) {
                    return line.slice(0, 5);  // Return first 5 stones
                }
            }

            return null;
        }

        // Check for draw
        function checkDraw() {
            for (let row = 0; row < 13; row++) {
                for (let col = 0; col < 13; col++) {
                    if (board[row][col] === null) return false;
                }
            }
            return true;
        }

        // Get local response without repetition
        function getLocalResponse(category, subcategory = null) {
            let responses;
            if (subcategory) {
                responses = localResponses[category][subcategory];
            } else {
                responses = localResponses[category];
            }

            const availableResponses = responses.filter(r => !localResponsesUsed.includes(r));

            if (availableResponses.length === 0) {
                localResponsesUsed = [];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            const selected = availableResponses[Math.floor(Math.random() * availableResponses.length)];
            localResponsesUsed.push(selected);

            if (localResponsesUsed.length > 10) {
                localResponsesUsed.shift();
            }

            return selected;
        }

        // Show message
        function showMessage(message) {
            document.getElementById('aiMessage').textContent = message;
        }

        // Update score display
        function updateScore() {
            document.getElementById('playerScore').textContent = score.player;
            document.getElementById('npcScore').textContent = score.npc;
        }

        // Update session info
        function updateSessionInfo() {
            document.getElementById('sessionGames').textContent = sessionGames;
            document.getElementById('totalGames').textContent = totalGamesToday;
        }

        // Show appropriate end buttons
        function showEndButtons() {
            const restartButton = document.querySelector('#gameActions .restart');
            const newSessionButton = document.querySelector('#gameActions .newSession');

            // Hide both buttons first
            restartButton.classList.remove('show');
            newSessionButton.classList.remove('show');

            if (sessionGames < 5) {
                restartButton.classList.add('show');
            } else {
                newSessionButton.classList.add('show');
                // End session message
                setTimeout(() => {
                    showMessage(
                        `‰ªäÊó•Êà∞Á∏æÔºöÊÇ®Ë¥è‰∫Ü${score.player}Â±ÄÔºåÊàëË¥è‰∫Ü${score.npc}Â±Ä„ÄÇ` +
                        `Ë¨ùË¨ùÈô™Êàë‰∏ãÊ£ãÔºÅÈªûÊìä„ÄåÊñ∞Â±Ä„ÄçÂèØ‰ª•ÂÜçÁé©„ÄÇ`
                    );
                }, 2000);
            }
        }

        // Hide end buttons from game actions
        function hideEndButtons() {
            const restartButton = document.querySelector('#gameActions .restart');
            const newSessionButton = document.querySelector('#gameActions .newSession');

            restartButton.classList.remove('show');
            newSessionButton.classList.remove('show');
        }

        // Start first game
        function startFirstGame() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');

            // Initialize session
            totalGamesToday = parseInt(localStorage.getItem('gomokuGamesToday') || '0');
            const lastPlayDate = localStorage.getItem('gomokuLastPlayDate');
            const today = new Date().toDateString();

            if (lastPlayDate !== today) {
                totalGamesToday = 0;
                localStorage.setItem('gomokuLastPlayDate', today);
            }

            startNewGame();
        }

        // Start new game
        function startNewGame() {
            hideEndButtons();
            initBoard();
            gameActive = true;
            isProcessing = false;
            sessionGames++;

            // Note: totalGamesToday is now incremented only when games are completed (won)

            updateSessionInfo();

            // Clear any buttons during game (now handled by gameActions)
            hideEndButtons();

            // Show greeting
            showMessage(getLocalResponse('greetings'));

            // Special messages
            if (sessionGames === 1 && totalGamesToday === 1) {
                const hour = new Date().getHours();
                const timeOfDay = hour < 12 ? 'Êó©‰∏ä' : hour < 17 ? '‰∏ãÂçà' : 'Êôö‰∏ä';
                showMessage(`${timeOfDay}Â•ΩÔºÅÊ≠°Ëøé‰æÜÁé©‰∫îÂ≠êÊ£ãÔºÅÊÇ®Âü∑ÈªëÂ≠êÂÖà‰∏ã„ÄÇ`);
            } else if (sessionGames > 3) {
                showMessage("ÊÇ®ÁúüÊúâËÄêÂøÉÔºÅÈÄôÊòØÁ¨¨" + sessionGames + "Â±Ä‰∫ÜÔºåÊÇ®ÂÖà‰∏ãÔºÅ");
            }
        }

        // New session
        function newSession() {
            // Reset session
            sessionGames = 0;
            score = { player: 0, npc: 0 };
            updateScore();

            // Show welcome screen again
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('welcomeScreen').style.display = 'block';

            const welcomeMessage = document.querySelector('.welcomeMessage');
            welcomeMessage.innerHTML = `Ê≠°ËøéÂõû‰æÜÔºÅ<br>‰ªäÊó•Êà∞Á∏æÂ∑≤ÈáçÁΩÆ<br>Ê∫ñÂÇôÂ•ΩÂÜç‰æÜ‰∏ÄÂ±Ä‰∫ÜÂóéÔºü`;
        }

        // Initialize on load
        window.onload = function() {
            // Check if returning player
            const lastPlayDate = localStorage.getItem('gomokuLastPlayDate');
            if (lastPlayDate) {
                const welcomeMessage = document.querySelector('.welcomeMessage');
                welcomeMessage.innerHTML = `Ê≠°ËøéÂõû‰æÜÔºÅ<br>Ê∫ñÂÇôÂ•ΩÁπºÁ∫å‰∏ãÊ£ã‰∫ÜÂóéÔºü`;
            }
        };
    </script>
</body>
</html>